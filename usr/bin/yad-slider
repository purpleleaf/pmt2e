#!/bin/sh

# Set desired level with a yad dialog box

# Dependencies: `alsa-utils`, `acpilight` or `light`, `yad`
# Arguments: [bri] | [vol]

case "$1" in
    bri*)
        # --- 1. Detect hardware backlight ---
        hw_backlight=$(
            if [ -d /sys/class/backlight ]; then
                for d in /sys/class/backlight/*; do
                    if [ -f "$d/brightness" ] && [ -f "$d/max_brightness" ]; then
                        echo "$d"
                        break
                    fi
                done
            fi
        )

        # If no hardware backlight exists â†’ warn user and stop
        if [ -z "$hw_backlight" ]; then
            yad --title="Backlight" \
                --window-icon="weather-clear-symbolic" \
                --image="weather-clear-symbolic" \
                --text="This system does not provide a hardware backlight interface." \
                --button=OK
            exit 1
        fi

        # --- 2. Check backend: light or xbacklight/acpilight ---
        if command -v light >/dev/null 2>&1; then
            lvl=$(light -G 2>/dev/null)
        elif command -v xbacklight >/dev/null 2>&1; then
            lvl=$(xbacklight -get 2>/dev/null)
        else
            yad --title="Backlight" \
                --window-icon="weather-clear-symbolic" \
                --image="weather-clear-symbolic" \
                --text="No software backend for controlling brightness was found.\n\
Please install light, acpilight or xorg-backlight." \
                --button=OK
            exit 1
        fi

        lvl=$(printf '%0.0f\n' "$lvl")

        yad --scale --value "$lvl" --print-partial --mouse --no-buttons \
            --undecorated --skip-taskbar --sticky --close-on-unfocus \
            --height 400 --vertical --on-top --class="yad_slider" 2>/dev/null |
        while IFS= read -r BRI; do
            if command -v light >/dev/null 2>&1; then
                light -S "$BRI" >/dev/null 2>&1
            else
                xbacklight -set "$BRI" >/dev/null 2>&1
            fi
        done &
    ;;

    vol*)
        # 1. Find the first control that actually has a % volume
        ctl=$(
            amixer scontrols |
            while IFS= read -r ctl; do
                case "$ctl" in
                    *"'"*"'"*)
                        name=$(printf '%s\n' "$ctl" | sed "s/.*'\(.*\)'.*/\1/")
                        if amixer get "$name" | grep -q '%'; then
                            printf '%s\n' "$name"
                            break
                        fi
                        ;;
                esac
            done
        )

        # Security check: fallback if empty
        # If no control was found, show a message and stop
        if [ -z "$ctl" ]; then
            yad --text="No volume control available on this device." \
                --button=OK --center --on-top
            exit 0
        fi

        # 2. Extract the numeric volume from that control
        lvl=$(
            amixer get "$ctl" |
            while IFS= read -r line; do
                case "$line" in
                    *%*)
                        set -- $(printf '%s\n' "$line" | tr '[]' '  ')
                        for field in "$@"; do
                            case "$field" in
                                *%)
                                    val=${field%%%}
                                    printf '%s\n' "$val"
                                    exit 0
                                    ;;
                            esac
                        done
                        ;;
                esac
            done
        )

        # 3. YAD slider controlling the detected control
        yad --scale --value "$lvl" --print-partial --mouse --no-buttons \
            --undecorated --skip-taskbar --sticky --close-on-unfocus \
            --height 400 --vertical --on-top --class="yad_slider" |
        while IFS= read -r VOL; do
            amixer sset "$ctl" "$VOL%" >/dev/null 2>&1
        done &
    ;;

    *)
        echo "Allowed arguments: vol | bri"
    ;;
esac
