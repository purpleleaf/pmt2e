#!/bin/sh

# Dependencies: xdotool wmctrl createjgmenu (for desktops menu)
# POSIX-compliant. Symlink this script to 'pmd' if you want menu entries to call 'pmd'.

scriptname=$(basename "$0")
action=""
output=""
outflag=""
output_only=0

die() {
  echo "$*" 1>&2
  exit 1
}

show_help() {
  cat <<EOF
Usage: $scriptname [action] [output] [args...]

Actions (choose one):
  -h          show this help
  -n          next desktop
  -p          previous desktop
  -m          show desktop menu
  -r          show "move windows to" menu
  -w <src> <dst>
              move windows from <src> to <dst> (both zero-based)

Output mode:
  -o          indicate the script should print an output (requires -i|-f|-t)
  -i          icon output
  -f          glyph (font) output
  -t          text output

Rules:
  - Only one action may be chosen (except -o which only requests output).
  - When -o is used, an output option (-i|-f|-t) is required.
  - When an action (other than -h) is chosen, an output option is required unless you only want the action to run.
EOF
}

help_error_action="Only one action can be chosen between -h -n -p -m -r -w"
help_error_output="Only one output can be chosen between -i -f -t"

# Parse options and set outflag at the same time
while getopts ":hnopmrwift" opt; do
  case "$opt" in
    h)
      [ -n "$action" ] && die "$help_error_action"
      action="help"
      output="help"
      ;;
    n)
      [ -n "$action" ] && die "$help_error_action"
      action="next"
      ;;
    p)
      [ -n "$action" ] && die "$help_error_action"
      action="previous"
      ;;
    m)
      [ -n "$action" ] && die "$help_error_action"
      action="menu"
      ;;
    r)
      [ -n "$action" ] && die "$help_error_action"
      action="right_menu"
      ;;
    w)
      [ -n "$action" ] && die "$help_error_action"
      action="windows"
      # -w takes two positional args; leave them after shift
      ;;
    o)
      output_only=1
      ;;
    i)
      [ -n "$output" ] && die "$help_error_output"
      output="icon"
      outflag='-i'
      ;;
    f)
      [ -n "$output" ] && die "$help_error_output"
      output="glyph"
      outflag='-f'
      ;;
    t)
      [ -n "$output" ] && die "$help_error_output"
      output="text"
      outflag='-t'
      ;;
    :)
      die "Option -$OPTARG requires an argument"
      ;;
    \?)
      die "Invalid option -$OPTARG"
      ;;
  esac
done

shift $((OPTIND - 1))

# Default outflag if none provided (so menu entries can reuse it)
if [ -z "$outflag" ]; then
  outflag='-t'   # default to text output
fi

# Validate option combinations
if [ -z "$action" ] && [ "$output_only" -eq 0 ]; then
  die "$scriptname requires an action (e.g. -n -p -m -r -w) or -o to request output-only. Run \"$scriptname -h\" for usage."
fi

if [ "$output_only" -eq 1 ] && [ -z "$output" ]; then
  die "When using -o you must choose an output with -i, -f, or -t."
fi

# If an action (other than help) is chosen and no output specified, require output
if [ -n "$action" ] && [ "$action" != "help" ] && [ -z "$output" ] && [ "$output_only" -eq 0 ]; then
  die "$scriptname requires an output (-i | -f | -t) when an action is chosen. Run \"$scriptname -h\" for usage."
fi

# Get current desktop (zero-based)
curr_desktop=$(xdotool get_desktop 2>/dev/null)
if [ -z "$curr_desktop" ]; then
  die "xdotool failed to get current desktop"
fi

case "$action" in
  help)
    show_help
    exit 0
    ;;
  next)
    xdotool set_desktop --relative 1
    ;;
  previous)
    xdotool set_desktop --relative -- -1
    ;;
  menu)
    desktop_num=$(xdotool get_num_desktops 2>/dev/null)
    [ -n "$desktop_num" ] || die "xdotool failed to get number of desktops"

    set --
    i=1
    while [ "$i" -le "$desktop_num" ]; do
      target=$((i - 1))
      set -- "$@" "Desktop $i,xdotool set_desktop $target"
      i=$((i + 1))
    done

    createjgmenu "^sep(Move to:)" "$@"
    ;;
  right_menu)
    desktop_num=$(xdotool get_num_desktops 2>/dev/null)
    [ -n "$desktop_num" ] || die "xdotool failed to get number of desktops"

    # Resolve absolute script path for menu invocation
    case "$0" in
      /*) script_cmd="$0" ;;
      *)  script_cmd="$PWD/$0" ;;
    esac

    # Check if there are windows on the current desktop
    windows_exist=$(wmctrl -l | awk -v var="$curr_desktop" '$2 == var { print $1; exit }')

    if [ -n "$windows_exist" ]; then
      set --
      i=1
      while [ "$i" -le "$desktop_num" ]; do
        target=$((i - 1))
        if [ "$target" -eq "$curr_desktop" ]; then
          i=$((i + 1))
          continue
        fi

        # Place the output option before the positional src/dst args so getopts parses it.
        # Example command that will be stored in the menu: sh -c '/full/path/pmd -w -t 0 1'
        cmd="sh -c '$script_cmd -w $outflag $curr_desktop $target'"

        set -- "$@" "Desktop $i,$cmd"
        i=$((i + 1))
      done

      createjgmenu "^sep(Move Windows to:)" "$@"
    else
      createjgmenu "^sep(No window to move)"
    fi
    ;;
  windows)
    # When invoked as: script -w <src> <dst>
    src="$1"
    dst="$2"
    if [ -z "$src" ] || [ -z "$dst" ]; then
      die "windows action requires two arguments: <source_desktop> <target_desktop>"
    fi

    # Read wmctrl output line-by-line, split into fields with the shell,
    # and move windows whose desktop field equals $src.
    wmctrl -l | while IFS= read -r line; do
      # split line into positional parameters: $1 = winid, $2 = desktop, rest = title...
      set -- $line
      winid=$1
      desk=$2

      [ -n "$winid" ] || continue

      if [ "$desk" = "$src" ]; then
        if command -v xdotool >/dev/null 2>&1; then
          xdotool set_desktop_for_window "$winid" "$dst"
        else
          wmctrl -i -r "$winid" -t "$dst"
        fi
      fi
    done

    # switch to destination desktop (prefer xdotool, fallback to wmctrl)
    if command -v xdotool >/dev/null 2>&1; then
      xdotool set_desktop "$dst"
    else
      wmctrl -s "$dst"
    fi

    exit 0
    ;;
  "")
    # no action chosen (possible when -o used); fall through to output printing
    ;;
  *)
    die "Unknown action: $action"
    ;;
esac

# Print output if requested (either via -o or because an action required output)
if [ -n "$output" ]; then
  # convert to 1-based desktop number for display
  curr_display=$(( $(xdotool get_desktop) + 1 ))
  case "$output" in
    glyph)
      printf 'Û∞ç∫ <span font-size="xx-small">%s</span>\n' "$curr_display"
      ;;
    text)
      printf 'Desk: %s\n' "$curr_display"
      ;;
    icon)
      printf '/usr/share/pmt2e/icons/desktop.svg\n%s\n' "$curr_display"
      ;;
    *)
      die "Unknown output: $output"
      ;;
  esac
fi

exit 0
